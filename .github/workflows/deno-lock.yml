name: Update dependencies

on:
  push:
    branches:
      - ci/update-deps
  schedule:
    - cron: "15 15 3,17 * *"
    - cron: "15 16 10 * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Two weeks, in minutes
  MIN_AGE: 20160

jobs:
  update:
    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout pull request
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2
        with:
          deno-version: v2.x
      - name: Set compatible update
        if: github.event.schedule != '15 16 10 * *'
        run: echo UPDATE_TYPE=compatible >> $GITHUB_ENV
      - name: Set latest update
        if: github.event.schedule == '15 16 10 * *'
        run: echo UPDATE_TYPE=latest >> $GITHUB_ENV
      - name: Set git identity
        run: |
          git config --global user.name "bids-maintenance"
          git config --global user.email "bids.maintenance@gmail.com"
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7
      - name: List updates
        run: >
          deno outdated --minimum-dependency-age $MIN_AGE --$UPDATE_TYPE |
          perl -0 -pe 's/[^[:ascii:]]//g; s/\n\n/\n/g; s/(^|\n) */$1/g' |
          uvx tabulate -f github -1 - |
          tee /tmp/outdated.md
        env:
          NO_COLOR: 1
      - name: Update dependencies
        run: >
          uvx datalad run -i deno.json -i deno.lock -o deno.json -o deno.lock --
          bash -c
          "deno update --compatible @bids/schema &&
           deno update --$UPDATE_TYPE --minimum-dependency-age $MIN_AGE '!@bids/schema'"
      - name: Make pull request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          branch: deps/${{ env.UPDATE_TYPE }}
          title: "chore(deps): Update strategy ${{ env.UPDATE_TYPE }}"
          body-path: /tmp/outdated.md
